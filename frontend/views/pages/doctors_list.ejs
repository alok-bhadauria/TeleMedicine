<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Find Doctors</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <link rel="stylesheet" href="/css/style.css">
</head>

<body>
    <div class="d-flex" id="wrapper">
        <%- include('../partials/sidebar') %>
            <div id="page-content-wrapper" class="main-gradient-bg">
                <nav class="navbar navbar-expand-lg navbar-light bg-transparent py-4 px-4">
                    <div class="d-flex align-items-center">
                        <i class="fas fa-align-left primary-text fs-4 me-3" id="menu-toggle"></i>
                        <h2 class="fs-2 m-0 text-dark fw-bold">Find Doctors</h2>
                    </div>
                </nav>
                <div class="container-fluid px-4">
                    <!-- Search Bar -->
                    <div class="row mb-5">
                        <div class="col-md-8 mx-auto">
                            <form action="/doctors" method="GET" class="position-relative">
                                <i
                                    class="fas fa-search position-absolute top-50 start-0 translate-middle-y ms-3 text-muted"></i>
                                <input type="text" name="search"
                                    class="form-control form-control-lg ps-5 rounded-pill shadow-sm border-0"
                                    placeholder="Search by Doctor Name, ID, or Speciality..."
                                    value="<%= typeof search !== 'undefined' ? search : '' %>">
                                <button type="submit"
                                    class="btn btn-primary rounded-pill position-absolute top-50 end-0 translate-middle-y me-2 px-4">Search</button>
                            </form>
                        </div>
                    </div>

                    <div class="row g-4">
                        <% if(doctors.length> 0) { %>
                            <% doctors.forEach(function(doc) { %>
                                <div class="col-md-6 col-lg-4">
                                    <div class="doctor-card d-flex flex-column">
                                        <!-- Header / Image -->
                                        <div class="position-relative">
                                            <img src="<%= getProfilePic(doc) %>" class="w-100"
                                                style="height: 240px; object-fit: cover;" alt="<%= doc.fullName %>">
                                            <div class="position-absolute bottom-0 start-0 w-100 h-50"
                                                style="background: linear-gradient(to top, rgba(0,0,0,0.8) 0%, transparent 100%);">
                                            </div>
                                            <div class="position-absolute bottom-0 start-0 w-100 p-4 text-white">
                                                <h5 class="fw-bold mb-1 text-shadow text-white display-font ls-tight">
                                                    Dr. <%= doc.fullName %>
                                                </h5>
                                                <span
                                                    class="badge bg-white text-primary bg-opacity-90 backdrop-blur-sm rounded-pill px-3 fw-medium">
                                                    <%= doc.speciality %>
                                                </span>
                                            </div>
                                            <% if (!doc.rating || doc.rating==='New' ) { %>
                                                <div class="position-absolute top-0 end-0 m-3">
                                                    <span
                                                        class="badge bg-primary text-white shadow-lg rounded-pill px-3 py-2 fw-bold text-uppercase tracking-wider"
                                                        style="font-size: 0.7rem;">
                                                        <i class="fas fa-star me-1 animate-pulse"></i> New
                                                    </span>
                                                </div>
                                                <% } else { %>
                                                    <div class="position-absolute top-0 end-0 m-3">
                                                        <span
                                                            class="badge bg-warning text-dark shadow-sm rounded-pill px-3 py-2 fw-bold">
                                                            <i class="fas fa-star me-1"></i>
                                                            <%= doc.rating %>
                                                        </span>
                                                    </div>
                                                    <% } %>
                                        </div>

                                        <!-- Body -->
                                        <div class="p-4 d-flex flex-column flex-grow-1">
                                            <div class="d-flex justify-content-between mb-3 text-muted small">
                                                <span class="d-flex align-items-center"><i
                                                        class="fas fa-briefcase me-2 text-primary"></i>
                                                    <%= doc.experience %> yrs Exp
                                                </span>
                                                <span class="fw-bold text-dark fs-5">$<%= doc.charges %>/hr</span>
                                            </div>
                                            <p class="text-muted small mb-4 flex-grow-1" style="line-height: 1.6;">
                                                <%= doc.bio ? (doc.bio.length> 80 ? doc.bio.substring(0, 80) + '...' :
                                                    doc.bio) : 'Experienced specialist dedicated to patient care.' %>
                                            </p>

                                            <!-- Actions -->
                                            <div class="d-grid gap-2">
                                                <div class="row g-2">
                                                    <div class="col-6">
                                                        <a href="/messages?userId=<%= doc._id %>"
                                                            class="btn btn-outline-secondary w-100 rounded-pill btn-sm py-2">
                                                            <i class="fas fa-comment-alt me-1"></i>Message
                                                        </a>
                                                    </div>
                                                    <div class="col-6">
                                                        <% if(doc.clinicLocation && doc.clinicLocation.lat) { %>
                                                            <button
                                                                class="btn btn-outline-info w-100 rounded-pill btn-sm py-2"
                                                                onclick="openMapModal('<%= doc.fullName %>', <%= doc.clinicLocation.lat %>, <%= doc.clinicLocation.lng %>)">
                                                                <i class="fas fa-map-marker-alt me-1"></i>Clinic
                                                            </button>
                                                            <% } else { %>
                                                                <button
                                                                    class="btn btn-light w-100 rounded-pill btn-sm text-muted py-2"
                                                                    disabled>
                                                                    <i class="fas fa-map-marker-alt me-1"></i>No Map
                                                                </button>
                                                                <% } %>
                                                    </div>
                                                </div>
                                                <button class="btn btn-primary w-100 rounded-pill py-2 shadow-sm"
                                                    onclick="openBookModal('<%= doc._id %>', 'Dr. <%= doc.fullName %>')">
                                                    Book Appointment
                                                </button>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                <% }) %>
                                    <% } else { %>
                                        <div class="col-12 text-center py-5">
                                            <img src="https://cdni.iconscout.com/illustration/premium/thumb/empty-state-2130362-1800926.png"
                                                height="200" class="mb-3 opacity-75">
                                            <h4 class="text-muted">No doctors found</h4>
                                            <p class="text-muted">Try adjusting your search criteria.</p>
                                            <a href="/doctors" class="btn btn-outline-primary rounded-pill">View All
                                                Doctors</a>
                                        </div>
                                        <% } %>
                    </div>
                </div>
            </div>
    </div>

    <!-- Reusing the Modal from Patient Dashboard, but ensuring it's available here too since this is a separate page -->
    <div class="modal fade" id="bookAppointmentModal" tabindex="-1">
        <div class="modal-dialog">
            <form action="/appointments/book" method="POST">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title">Book Appointment with <span id="docNameSpan"></span></h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                    </div>
                    <div class="modal-body">
                        <input type="hidden" name="doctorId" id="modalDocId">
                        <div class="mb-3">
                            <label>Date</label>
                            <input type="date" name="date" class="form-control" required>
                        </div>
                        <div class="mb-3">
                            <label>Time Slot</label>
                            <select name="timeSlot" class="form-select">
                                <option>10:00 AM</option>
                                <option>11:00 AM</option>
                                <option>02:00 PM</option>
                                <option>04:00 PM</option>
                            </select>
                        </div>
                        <div class="mb-3">
                            <label>Symptoms</label>
                            <textarea name="symptoms" class="form-control"></textarea>
                        </div>

                        <% if(typeof reports !=='undefined' && reports.length> 0) { %>
                            <div class="mb-3">
                                <label class="form-label text-muted small fw-bold">Share Reports (Optional)</label>
                                <div class="card p-2 bg-light border-0" style="max-height: 150px; overflow-y: auto;">
                                    <% reports.forEach(function(rep) { %>
                                        <div class="form-check">
                                            <input class="form-check-input" type="checkbox" name="sharedReports"
                                                value="<%= rep._id %>" id="rep_<%= rep._id %>">
                                            <label class="form-check-label small" for="rep_<%= rep._id %>">
                                                <%= rep.title %> (<%= new Date(rep.uploadedAt).toLocaleDateString() %>)
                                            </label>
                                        </div>
                                        <% }) %>
                                </div>
                            </div>
                            <% } %>
                    </div>
                    <div class="modal-footer">
                        <button type="submit" class="btn btn-primary">Confirm Booking</button>
                    </div>
                </div>
            </form>
        </div>
    </div>

    <!-- Map Modal -->
    <div class="modal fade" id="mapModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-lg modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header bg-light border-0">
                    <h5 class="modal-title fw-bold"><i class="fas fa-map-marker-alt text-danger me-2"></i><span
                            id="mapDocName"></span>'s Clinic</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body p-0">
                    <div id="viewMap" style="height: 400px; width: 100%;"></div>
                </div>
            </div>
        </div>
    </div>

    <!-- Leaflet CSS & JS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

    <script>
        function openBookModal(docId, docName) {
            document.getElementById('modalDocId').value = docId;
            document.getElementById('docNameSpan').innerText = docName;
            new bootstrap.Modal(document.getElementById('bookAppointmentModal')).show();
        }

        var viewMap = null;
        function openMapModal(docName, lat, lng) {
            document.getElementById('mapDocName').innerText = docName;
            var modal = new bootstrap.Modal(document.getElementById('mapModal'));
            modal.show();

            // Initialize map after modal is shown to avoid size issues
            document.getElementById('mapModal').addEventListener('shown.bs.modal', function () {
                if (viewMap) {
                    viewMap.remove(); // Cleanup previous map instance
                }
                viewMap = L.map('viewMap').setView([lat, lng], 15);
                L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                    attribution: 'OpenStreetMap'
                }).addTo(viewMap);
                L.marker([lat, lng]).addTo(viewMap)
                    .bindPopup("<b>Dr. " + docName + "'s Clinic</b><br>Here!")
                    .openPopup();
            }, { once: true });
            // Note: once:true might prevent re-opening for others if listeners stack, simpler to just trigger resize or re-init always.
            // Better approach: handle map creation carefully.
        }

        // Simpler Map Logic to avoid listener stacking:
        var mapInstance = null;
        function openMapModal(docName, lat, lng) {
            document.getElementById('mapDocName').innerText = docName;
            var myModal = new bootstrap.Modal(document.getElementById('mapModal'));
            myModal.show();

            // Wait for modal transition
            setTimeout(() => {
                if (mapInstance) {
                    mapInstance.remove();
                }
                mapInstance = L.map('viewMap').setView([lat, lng], 15);
                L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                    attribution: 'OpenStreetMap'
                }).addTo(mapInstance);
                L.marker([lat, lng]).addTo(mapInstance)
                    .bindPopup("<b>Dr. " + docName + "'s Clinic</b>").openPopup();
            }, 500);
        }
    </script>

    <%- include('../partials/footer') %>
        <script>
            var el = document.getElementById("wrapper");
            var toggleButton = document.getElementById("menu-toggle");
            if (toggleButton) {
                toggleButton.onclick = function () {
                    el.classList.toggle("toggled");
                };
            }
        </script>
</body>

</html>