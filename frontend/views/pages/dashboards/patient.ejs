<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>
        <%= title %>
    </title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <link rel="stylesheet" href="/css/style.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <!-- Leaflet CSS & JS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
</head>

<body>
    <div class="d-flex" id="wrapper">
        <!-- Sidebar -->
        <%- include('../../partials/sidebar') %>

            <!-- Page Content -->
            <div id="page-content-wrapper">
                <!-- Top Navbar for Mobile Toggle -->
                <nav class="navbar navbar-expand-lg navbar-light bg-transparent py-4 px-4">
                    <div class="d-flex align-items-center">
                        <i class="fas fa-align-left primary-text fs-4 me-3" id="menu-toggle"></i>
                        <h2 class="fs-2 m-0 text-dark fw-bold">Dashboard</h2>
                    </div>
                </nav>

                <div class="container-fluid px-4">
                    <!-- Welcome Widget -->
                    <div class="row g-3 my-4">
                        <div class="col-12">
                            <div class="dash-card welcome-card-bg p-4 text-white">
                                <div class="d-flex justify-content-between align-items-center position-relative"
                                    style="z-index: 2;">
                                    <div>
                                        <h2 class="fw-bold mb-1">Welcome back, <%= user.fullName %>!</h2>
                                        <p class="mb-0 opacity-75">Member ID: <%= user._id %>
                                        </p>
                                    </div>
                                    <img src="<%= user.profilePic || '/images/default-profile.png' %>" alt="Profile"
                                        class="profile-avatar rounded-circle">
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Stats Widgets -->
                    <div class="row g-3 my-2">
                        <div class="col-md-4">
                            <div class="dash-card p-3 d-flex justify-content-between align-items-center h-100">
                                <div>
                                    <p class="text-muted small mb-1 fw-bold">NEXT APPOINTMENT</p>
                                    <% if(nextAppointment) { %>
                                        <h5 class="fw-bold fs-5 mb-0">Dr. <%= nextAppointment.doctorId.fullName %>
                                        </h5>
                                        <p class="mb-0 text-primary small">
                                            <%= new Date(nextAppointment.date).toDateString() %>
                                        </p>
                                        <% } else { %>
                                            <h5 class="fw-bold text-muted mb-0">No Upcoming</h5>
                                            <a href="/doctors" class="small text-primary text-decoration-none">Book
                                                Now</a>
                                            <% } %>
                                </div>
                                <div class="stat-icon-wrapper bg-blue-100 text-primary bg-opacity-10">
                                    <i class="fas fa-calendar-check"></i>
                                </div>
                            </div>
                        </div>

                        <div class="col-md-4">
                            <div class="dash-card p-4 d-flex justify-content-between align-items-center">
                                <div>
                                    <p class="text-muted small mb-1 fw-bold text-uppercase">Health Vitals</p>
                                    <h4 class="fw-bold mb-0">
                                        <%= (recentVitals && recentVitals.find(v=> v.type === 'weight')) ?
                                            recentVitals.find(v => v.type === 'weight').value + ' kg' : 'No Data' %>
                                    </h4>
                                </div>
                                <div class="stat-icon-wrapper text-success bg-success bg-opacity-10">
                                    <i class="fas fa-heartbeat"></i>
                                </div>
                            </div>
                        </div>

                        <div class="col-md-4">
                            <div class="dash-card p-4 d-flex justify-content-between align-items-center">
                                <div>
                                    <p class="text-muted small mb-1 fw-bold text-uppercase">New Messages</p>
                                    <h4 class="fw-bold mb-0">0</h4>
                                </div>
                                <div class="stat-icon-wrapper text-warning bg-warning bg-opacity-10">
                                    <i class="fas fa-comment-dots"></i>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Main Content Row -->
                    <div class="row g-3 my-2">
                        <div class="col-md-8">
                            <div class="dash-card p-4 h-100">
                                <div class="d-flex justify-content-between align-items-center mb-4">
                                    <h5 class="fw-bold mb-0">Health Overview</h5>
                                    <div class="d-flex gap-2">
                                        <button
                                            class="btn btn-sm btn-light border rounded-3 p-2 d-flex align-items-center justify-content-center chart-toggle active"
                                            data-type="heart_rate" style="width: 40px; height: 40px;"
                                            title="Heart Rate">
                                            <i class="fas fa-heartbeat text-danger"></i>
                                        </button>
                                        <button
                                            class="btn btn-sm btn-light border rounded-3 p-2 d-flex align-items-center justify-content-center chart-toggle"
                                            data-type="weight" style="width: 40px; height: 40px;" title="Weight">
                                            <i class="fas fa-weight text-primary"></i>
                                        </button>
                                        <button
                                            class="btn btn-sm btn-light border rounded-3 p-2 d-flex align-items-center justify-content-center chart-toggle"
                                            data-type="blood_pressure" style="width: 40px; height: 40px;"
                                            title="Blood Pressure">
                                            <i class="fas fa-tint text-info"></i>
                                        </button>
                                    </div>
                                </div>
                                <div id="healthOverviewChart" style="min-height: 250px;"></div>
                                <div id="chartInsight"
                                    class="mt-3 p-2 bg-light rounded text-muted small border-start border-4 border-info fst-italic">
                                    Select a metric to view insights.
                                </div>

                                <% if(!recentVitals || recentVitals.length===0) { %>
                                    <div id="noDataMessage" class="text-center text-muted py-5" style="display: none;">
                                        <i class="fas fa-heartbeat fs-1 mb-3 opacity-25"></i>
                                        <p>No health data recorded yet.</p>
                                        <a href="/health-track" class="btn btn-sm btn-outline-primary">Add Vitals</a>
                                    </div>
                                    <% } %>
                            </div>
                            <!-- ApexCharts -->
                            <script src="https://cdn.jsdelivr.net/npm/apexcharts"></script>
                            <script>
                                document.addEventListener('DOMContentLoaded', async function () {
                                    let chart; // Global chart instance
                                    let allData = [];

                                    try {
                                        const response = await fetch('/vitals/data');
                                        const rawData = await response.json();

                                        if (!rawData || rawData.length === 0) {
                                            document.getElementById('noDataMessage').style.display = 'block';
                                            document.getElementById('healthOverviewChart').style.display = 'none';
                                            document.getElementById('chartInsight').style.display = 'none';
                                            return;
                                        }

                                        // Sort ascending
                                        allData = rawData.sort((a, b) => new Date(a.recordedAt) - new Date(b.recordedAt));

                                        // Initial Render (Heart Rate)
                                        renderChart('heart_rate');

                                        // Event Listeners for Buttons
                                        document.querySelectorAll('.chart-toggle').forEach(btn => {
                                            btn.addEventListener('click', function () {
                                                // Remove active class from all
                                                document.querySelectorAll('.chart-toggle').forEach(b => b.classList.remove('active', 'bg-light-subtle'));
                                                // Add active to clicked
                                                this.classList.add('active', 'bg-light-subtle');

                                                const type = this.getAttribute('data-type');
                                                renderChart(type);
                                            });
                                        });

                                    } catch (error) {
                                        console.error('Error loading health overview:', error);
                                    }

                                    function renderChart(type) {
                                        // filter data
                                        let filteredData = allData.filter(d => d.type === type);
                                        let title, color, suffix, icon;

                                        if (type === 'heart_rate') {
                                            title = "Heart Rate"; color = '#dc3545'; suffix = ' bpm'; icon = 'fa-heartbeat';
                                        } else if (type === 'weight') {
                                            title = "Weight"; color = '#0d6efd'; suffix = ' kg'; icon = 'fa-weight';
                                        } else if (type === 'blood_pressure') {
                                            title = "Blood Pressure"; color = '#0dcaf0'; suffix = ''; icon = 'fa-tint';
                                            // Handle BP specific data structure (sys/dia) logic if needed, simple mapping for now
                                        }

                                        // Only handle empty filtered data gracefully if previously user had data
                                        if (filteredData.length === 0) {
                                            if (chart) chart.destroy();
                                            document.getElementById('healthOverviewChart').innerHTML = `<div class="text-center text-muted py-5">No ${title} data recorded yet.</div>`;
                                            document.getElementById('chartInsight').innerHTML = `Start logging your ${title} to see trends here.`;
                                            return;
                                        } else {
                                            // Clear empty message if any
                                            document.getElementById('healthOverviewChart').innerHTML = "";
                                        }

                                        // Prepare Series
                                        let series = [];
                                        if (type === 'blood_pressure') {
                                            const sysData = filteredData.map(d => ({ x: new Date(d.recordedAt).getTime(), y: parseFloat(d.value.split('/')[0] || 0) }));
                                            const diaData = filteredData.map(d => ({ x: new Date(d.recordedAt).getTime(), y: parseFloat(d.value.split('/')[1] || 0) }));
                                            series = [
                                                { name: 'Systolic', data: sysData },
                                                { name: 'Diastolic', data: diaData }
                                            ];
                                        } else {
                                            series = [{
                                                name: title,
                                                data: filteredData.map(d => ({
                                                    x: new Date(d.recordedAt).getTime(),
                                                    y: parseFloat(d.value)
                                                }))
                                            }];
                                        }

                                        // Chart Options
                                        const options = {
                                            series: series,
                                            chart: {
                                                type: 'area',
                                                height: 250,
                                                toolbar: { show: false },
                                                fontFamily: 'inherit',
                                                animations: { enabled: true }
                                            },
                                            colors: type === 'blood_pressure' ? [color, '#6610f2'] : [color],
                                            stroke: {
                                                curve: 'smooth',
                                                width: 3,
                                                dashArray: type === 'blood_pressure' ? [0, 5] : 0
                                            },
                                            fill: {
                                                type: "gradient",
                                                gradient: {
                                                    shadeIntensity: 1,
                                                    opacityFrom: 0.55,
                                                    opacityTo: 0.05,
                                                    stops: [0, 100]
                                                }
                                            },
                                            dataLabels: { enabled: false },
                                            xaxis: {
                                                type: 'datetime',
                                                tooltip: { enabled: false }
                                            },
                                            grid: {
                                                strokeDashArray: 4,
                                                xaxis: { lines: { show: false } }
                                            }
                                        };

                                        // Destroy previous
                                        if (chart) chart.destroy();
                                        chart = new ApexCharts(document.querySelector("#healthOverviewChart"), options);
                                        chart.render();

                                        // Generate Insight
                                        generateInsight(filteredData, type, title);
                                    }

                                    function generateInsight(data, type, title) {
                                        if (data.length < 2) {
                                            document.getElementById('chartInsight').innerHTML = `Not enough data to generate a trend for <strong>${title}</strong>. Keep logging!`;
                                            return;
                                        }

                                        // Simple linear trend check
                                        const values = data.map(d => {
                                            if (type === 'blood_pressure') return parseFloat(d.value.split('/')[0]); // Use systolic for trend
                                            return parseFloat(d.value);
                                        });

                                        const first = values[0];
                                        const last = values[values.length - 1];
                                        const diff = last - first;

                                        let trend = "stable";
                                        if (diff > 0) trend = "increasing";
                                        if (diff < 0) trend = "decreasing";

                                        let message = "";
                                        if (type === 'weight') {
                                            if (trend === 'decreasing') message = `Great job! Your weight is <strong>trending down</strong> by ${Math.abs(diff).toFixed(1)}kg since your first log.`;
                                            else if (trend === 'increasing') message = `Your weight has <strong>increased</strong> by ${diff.toFixed(1)}kg. Keep an eye on your diet and activity.`;
                                            else message = `Your weight has remained <strong>stable</strong> over this period.`;
                                        } else if (type === 'heart_rate') {
                                            if (Math.abs(diff) < 5) message = `Your heart rate is <strong>stable</strong>. A consistent resting heart rate is a good sign of heart health.`;
                                            else if (trend === 'increasing') message = `Your heart rate shows an <strong>increasing trend</strong>. Ensure you are well-rested and hydrated.`;
                                            else message = `Your heart rate is <strong>trending lower</strong>, which can indicate improved cardiovascular fitness.`;
                                        } else if (type === 'blood_pressure') {
                                            message = `Your blood pressure readings are being tracked. Consistency is key for accurate monitoring.`;
                                        }

                                        document.getElementById('chartInsight').innerHTML = `<i class="fas fa-info-circle me-1"></i> ${message}`;
                                    }
                                });
                            </script>
                        </div>
                        <div class="col-md-4">
                            <div class="dash-card p-4">
                                <h5 class="fw-bold mb-4">Quick Actions</h5>
                                <div class="row g-3">
                                    <div class="col-6">
                                        <a href="/doctors" class="action-card">
                                            <i class="fas fa-user-md text-primary"></i>
                                            <div>
                                                <div class="title">Find Doctor</div>
                                                <div class="subtitle">Book Appointment</div>
                                            </div>
                                        </a>
                                    </div>

                                    <div class="col-6">
                                        <button type="button"
                                            class="action-card w-100 border-warning bg-warning bg-opacity-10"
                                            data-bs-toggle="modal" data-bs-target="#reminderModal">
                                            <i class="fas fa-bell text-warning"></i>
                                            <div>
                                                <div class="title text-dark">Reminder</div>
                                                <div class="subtitle text-muted opacity-75">Set New Alert</div>
                                            </div>
                                        </button>
                                    </div>
                                    <div class="col-6">
                                        <button type="button"
                                            class="action-card w-100 text-start border-danger bg-danger bg-opacity-10"
                                            data-bs-toggle="modal" data-bs-target="#emergencyModal">
                                            <i class="fas fa-ambulance text-danger"></i>
                                            <div>
                                                <div class="title text-danger">Emergency</div>
                                                <div class="subtitle text-danger opacity-75">Call Now</div>
                                            </div>
                                        </button>
                                    </div>
                                    <div class="col-6">
                                        <button type="button"
                                            class="action-card w-100 text-start border-info bg-info bg-opacity-10"
                                            data-bs-toggle="modal" data-bs-target="#feedbackModal">
                                            <i class="fas fa-comment-alt text-info"></i>
                                            <div>
                                                <div class="title text-info">Feedback</div>
                                                <div class="subtitle text-info opacity-75">Rate & Suggest</div>
                                            </div>
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
    </div>

    <!-- Reminder Modal -->
    <div class="modal fade" id="reminderModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content border-0 shadow-lg overflow-hidden">
                <div class="modal-header bg-warning text-white border-0">
                    <h5 class="modal-title fw-bold"><i class="fas fa-bell me-2"></i>Add Reminder</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"
                        aria-label="Close"></button>
                </div>
                <div class="modal-body p-4 bg-light">
                    <form action="/reminders/add?redirect=dashboard" method="POST">
                        <div class="mb-3">
                            <label class="form-label fw-bold small text-muted">Reminder Type</label>
                            <select class="form-select border-0 shadow-sm" name="type" required>
                                <option value="Medicine">üíä Medicine</option>
                                <option value="Appointment">üìÖ Appointment</option>
                                <option value="General">üìù General</option>
                            </select>
                        </div>
                        <div class="mb-3">
                            <label class="form-label fw-bold small text-muted">Description</label>
                            <input type="text" class="form-control border-0 shadow-sm" name="description"
                                placeholder="e.g. Take Vitamin C" required>
                        </div>
                        <div class="mb-3">
                            <label class="form-label fw-bold small text-muted">Time</label>
                            <input type="datetime-local" class="form-control border-0 shadow-sm" name="datetime"
                                required>
                        </div>
                        <button type="submit" class="btn btn-warning text-white fw-bold shadow-sm">
                            <i class="fas fa-plus me-2"></i>Add Reminder
                        </button>
                </div>
                </form>
                <div class="d-grid mt-2">
                    <a href="/reminders" class="btn btn-outline-secondary rounded-pill">Open Reminders Panel</a>
                </div>
            </div>
        </div>
    </div>
    </div>

    <!-- Emergency Modal -->
    <div class="modal fade" id="emergencyModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-lg modal-dialog-centered">
            <div class="modal-content border-0 shadow-lg overflow-hidden">
                <div class="modal-header bg-danger text-white border-0">
                    <h5 class="modal-title fw-bold"><i class="fas fa-ambulance me-2"></i>Emergency Response</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"
                        aria-label="Close"></button>
                </div>
                <div class="modal-body p-0">
                    <!-- Map Container -->
                    <div id="emergencyMap" style="height: 350px; width: 100%;"></div>

                    <!-- Controls Section (Below Map) -->
                    <div class="p-4 bg-light border-top">
                        <div class="d-flex align-items-center justify-content-between">
                            <div>
                                <h6 class="fw-bold text-danger mb-1"><i class="fas fa-search-location me-2"></i>Status:
                                    Active</h6>
                                <small class="text-muted">Locating nearby emergency units...</small>
                            </div>
                            <button id="callEmergencyBtn"
                                class="btn btn-danger btn-lg rounded-pill fw-bold px-4 shadow pulse-animation"
                                onclick="triggerEmergencyCall()">
                                <i class="fas fa-phone-alt me-2"></i>Call Emergency Service
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        let map, userMarker;

        // Robust FontAwesome Marker Icon for Ambulance
        const ambulanceIcon = L.divIcon({
            html: '<div class="bg-white rounded-circle shadow-sm d-flex align-items-center justify-content-center border border-danger" style="width: 32px; height: 32px;"><i class="fas fa-ambulance text-danger"></i></div>',
            className: 'custom-div-icon',
            iconSize: [32, 32],
            iconAnchor: [16, 32],
            popupAnchor: [0, -32]
        });

        const userIcon = L.divIcon({
            html: '<div class="bg-primary border-2 border-white rounded-circle shadow pulse-animation" style="width: 20px; height: 20px; border: 3px solid white;"></div>',
            className: 'custom-div-icon',
            iconSize: [20, 20],
            iconAnchor: [10, 10]
        });

        // Init Map when Modal Opens
        const emergencyModal = document.getElementById('emergencyModal');
        emergencyModal.addEventListener('shown.bs.modal', function () {
            // Default center (can be browser location)
            const defaultLat = 28.6139; // New Delhi (Example)
            const defaultLng = 77.2090;

            if (!map) {
                map = L.map('emergencyMap').setView([defaultLat, defaultLng], 13);
                L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                    attribution: '¬© OpenStreetMap contributors'
                }).addTo(map);

                // Try to get real location
                if (navigator.geolocation) {
                    navigator.geolocation.getCurrentPosition(position => {
                        const { latitude, longitude } = position.coords;
                        map.setView([latitude, longitude], 14);

                        // Add User Marker
                        L.marker([latitude, longitude], { icon: userIcon }).addTo(map)
                            .bindPopup("You are here").openPopup();

                        // Add Random Ambulances nearby
                        addRandomAmbulances(latitude, longitude);
                    }, () => {
                        // Fallback
                        addRandomAmbulances(defaultLat, defaultLng);
                    });
                } else {
                    addRandomAmbulances(defaultLat, defaultLng);
                }
            } else {
                map.invalidateSize(); // Fix map rendering if opened again
            }
        });

        function addRandomAmbulances(lat, lng) {
            // Generate 3-5 random locations around center
            const count = Math.floor(Math.random() * 3) + 3;
            for (let i = 0; i < count; i++) {
                // Random offset roughly within few kms
                const latOffset = (Math.random() - 0.5) * 0.04;
                const lngOffset = (Math.random() - 0.5) * 0.04;

                L.marker([lat + latOffset, lng + lngOffset], { icon: ambulanceIcon })
                    .addTo(map)
                    .bindPopup("üöë Emergency Unit #" + (i + 1) + "<br>Status: Available");
            }
        }

        function triggerEmergencyCall() {
            const btn = document.getElementById('callEmergencyBtn');
            const originalText = btn.innerHTML;

            // Loading State
            btn.disabled = true;
            btn.innerHTML = `<span class="spinner-border spinner-border-sm me-2"></span>Connecting...`;

            // Simulate Connection
            setTimeout(() => {
                Swal.fire({
                    title: 'Connecting...',
                    text: 'Connecting you to a nearby emergency service vehicle, please standby...',
                    icon: 'warning',
                    showConfirmButton: false,
                    timer: 4000,
                    timerProgressBar: true,
                    willClose: () => {
                        Swal.fire({
                            title: 'Connected!',
                            text: 'Emergency services have been alerted. A unit is dispatching to your location.',
                            icon: 'success',
                            confirmButtonColor: '#dc3545'
                        });
                        btn.disabled = false;
                        btn.innerHTML = originalText;
                    }
                });
            }, 1500);
        }
    </script>

    <!-- Feedback Modal -->
    <div class="modal fade" id="feedbackModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content border-0 shadow-lg overflow-hidden">
                <div class="modal-header bg-info text-white border-0">
                    <h5 class="modal-title fw-bold"><i class="fas fa-star me-2"></i>Send Feedback</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"
                        aria-label="Close"></button>
                </div>
                <div class="modal-body p-4 bg-light">
                    <form id="feedbackForm">
                        <div class="mb-3 text-center">
                            <label
                                class="form-label d-block text-muted small fw-bold text-uppercase tracking-wide mb-2">How
                                was your experience?</label>
                            <div class="star-rating d-inline-flex gap-2">
                                <i class="fas fa-star fa-2x text-muted cursor-pointer" data-rating="1"></i>
                                <i class="fas fa-star fa-2x text-muted cursor-pointer" data-rating="2"></i>
                                <i class="fas fa-star fa-2x text-muted cursor-pointer" data-rating="3"></i>
                                <i class="fas fa-star fa-2x text-muted cursor-pointer" data-rating="4"></i>
                                <i class="fas fa-star fa-2x text-muted cursor-pointer" data-rating="5"></i>
                            </div>
                            <input type="hidden" name="rating" id="feedbackRating">
                        </div>

                        <div class="mb-3">
                            <label class="form-label fw-bold small text-muted">Feedback Type</label>
                            <select class="form-select border-0 shadow-sm" name="type" required>
                                <option value="Rating">‚≠ê General Rating</option>
                                <option value="Suggestion">üí° Suggestion</option>
                                <option value="Idea">‚ú® New Idea</option>
                                <option value="Complaint">‚ö†Ô∏è Complaint</option>
                                <option value="Query">‚ùì Query</option>
                            </select>
                        </div>

                        <div class="mb-3">
                            <label class="form-label fw-bold small text-muted">Your Message</label>
                            <textarea class="form-control border-0 shadow-sm" name="message" rows="4"
                                placeholder="Tell us what you think..." required></textarea>
                        </div>

                        <div class="d-grid">
                            <button type="submit" class="btn btn-info text-white fw-bold shadow-sm feedback-submit-btn">
                                Submit Feedback <i class="fas fa-paper-plane ms-2"></i>
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <style>
        /* Feedback Animations */
        .cursor-pointer {
            cursor: pointer;
        }

        .star-rating i {
            transition: transform 0.2s, color 0.2s;
        }

        .star-rating i:hover {
            transform: scale(1.2);
        }

        .text-warning {
            color: #ffc107 !important;
        }

        /* Modal Animation */
        .modal.fade .modal-dialog {
            transform: scale(0.9);
            transition: transform 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        }

        .modal.show .modal-dialog {
            transform: scale(1);
        }

        /* Button Hover */
        .feedback-submit-btn {
            transition: all 0.3s ease;
        }

        .feedback-submit-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(13, 202, 240, 0.4) !important;
        }
    </style>

    <script>
        document.addEventListener('DOMContentLoaded', function () {
            const stars = document.querySelectorAll('.star-rating i');
            const ratingInput = document.getElementById('feedbackRating');
            let currentRating = 0;

            // Star Hover Effect
            stars.forEach(star => {
                star.addEventListener('mouseover', function () {
                    const rating = this.dataset.rating;
                    highlightStars(rating);
                });

                star.addEventListener('mouseout', function () {
                    highlightStars(currentRating);
                });

                star.addEventListener('click', function () {
                    currentRating = this.dataset.rating;
                    ratingInput.value = currentRating;
                    highlightStars(currentRating);

                    // Micro-animation: pop effect
                    this.style.transform = "scale(1.4)";
                    setTimeout(() => this.style.transform = "scale(1.2)", 200);
                });
            });

            function highlightStars(rating) {
                stars.forEach(star => {
                    if (star.dataset.rating <= rating) {
                        star.classList.remove('text-muted');
                        star.classList.add('text-warning');
                    } else {
                        star.classList.add('text-muted');
                        star.classList.remove('text-warning');
                    }
                });
            }

            // Form Submission
            document.getElementById('feedbackForm').addEventListener('submit', async function (e) {
                e.preventDefault();
                const btn = this.querySelector('button[type="submit"]');
                const originalText = btn.innerHTML;

                btn.disabled = true;
                btn.innerHTML = '<span class="spinner-border spinner-border-sm me-2"></span>Sending...';

                try {
                    const formData = Object.fromEntries(new FormData(this));
                    const res = await fetch('/feedback/submit', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(formData)
                    });
                    const data = await res.json();

                    if (data.success) {
                        // Success Animation
                        btn.classList.remove('btn-info');
                        btn.classList.add('btn-success');
                        btn.innerHTML = '<i class="fas fa-check me-2"></i>Thansk!'; // user typo "Thansk", keeping it friendly or correcting? Let's correct to "Thanks!"
                        btn.innerHTML = '<i class="fas fa-check me-2"></i>Thank You!';

                        setTimeout(() => {
                            const modal = bootstrap.Modal.getInstance(document.getElementById('feedbackModal'));
                            modal.hide();
                            this.reset();
                            currentRating = 0;
                            highlightStars(0);

                            // Reset button
                            setTimeout(() => {
                                btn.classList.add('btn-info');
                                btn.classList.remove('btn-success');
                                btn.innerHTML = originalText;
                                btn.disabled = false;
                            }, 500);
                        }, 1500);
                    } else {
                        alert(data.error);
                        btn.innerHTML = originalText;
                        btn.disabled = false;
                    }
                } catch (err) {
                    console.error(err);
                    alert('Something went wrong');
                    btn.innerHTML = originalText;
                    btn.disabled = false;
                }
            });
        });
    </script>

    <!-- Floating Chatbot Button & Window -->
    <!-- Chatbot already included in footer -->

    <!-- Include Footer Scripts -->
    <%- include('../../partials/footer') %>

        <script>
            var el = document.getElementById("wrapper");
            var toggleButton = document.getElementById("menu-toggle");

            toggleButton.onclick = function () {
                el.classList.toggle("toggled");
            };


        </script>
</body>

</html>