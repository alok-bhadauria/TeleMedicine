<div id="ai-chatbot-container">
    <!-- Floating Toggle Button -->
    <button id="chatbot-toggle-btn"
        class="btn btn-dark rounded-pill shadow-lg d-flex align-items-center gap-2 border-0 px-4 py-3"
        style="position: fixed; bottom: 20px; right: 30px; z-index: 1050; transition: transform 0.3s; min-width: 140px;">
        <i class="fas fa-robot fa-lg text-primary"></i>
        <span class="fw-bold text-white mb-0" style="font-size: 1rem; letter-spacing: 0.5px;">MediBot</span>
    </button>

    <!-- Chat Window -->
    <div id="chatbot-window" class="card shadow-lg"
        style="position: fixed; bottom: 90px; right: 30px; width: 350px; height: 500px; z-index: 1050; display: none; border-radius: 15px; overflow: hidden; flex-direction: column;">

        <!-- Header -->
        <div class="card-header bg-primary text-white d-flex justify-content-between align-items-center py-3">
            <div class="d-flex align-items-center gap-2">
                <i class="fas fa-robot"></i>
                <h6 class="mb-0 fw-bold">MediBot AI</h6>
            </div>
            <button id="chatbot-close-btn" class="btn btn-sm text-white"><i class="fas fa-times"></i></button>
        </div>

        <!-- Messages Area -->
        <div id="chatbot-messages" class="card-body bg-light overflow-auto p-3" style="flex: 1;">
            <div class="d-flex align-items-start mb-3">
                <div class="bg-white p-2 rounded shadow-sm text-dark"
                    style="max-width: 80%; border-bottom-left-radius: 0;">
                    Hello! I'm your AI health assistant. How can I help you today?
                </div>
            </div>
        </div>

        <!-- Input Area -->
        <div class="card-footer bg-white p-2 border-top">
            <form id="chatbot-form" class="d-flex gap-2">
                <input type="text" id="chatbot-input" class="form-control border-0 bg-light rounded-pill"
                    placeholder="Ask a health question..." autocomplete="off">
                <button type="button" id="mic-btn"
                    class="btn btn-secondary rounded-circle d-flex align-items-center justify-content-center me-1"
                    style="width: 38px; height: 38px;">
                    <i class="fas fa-microphone fa-sm"></i>
                </button>
                <button type="submit"
                    class="btn btn-primary rounded-circle d-flex align-items-center justify-content-center"
                    style="width: 38px; height: 38px;">
                    <i class="fas fa-paper-plane fa-sm"></i>
                </button>
            </form>
        </div>
    </div>
</div>

<style>
    /* Chat Bubble Styles */
    .chat-bubble-user {
        background: #0d6efd;
        color: white;
        padding: 8px 12px;
        border-radius: 12px;
        border-bottom-right-radius: 0;
        max-width: 80%;
        margin-left: auto;
        font-size: 0.9rem;
    }

    .chat-bubble-ai {
        background: white;
        color: #333;
        padding: 8px 12px;
        border-radius: 12px;
        border-bottom-left-radius: 0;
        max-width: 80%;
        margin-right: auto;
        font-size: 0.9rem;
        box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
    }

    .typing-dot {
        width: 6px;
        height: 6px;
        background: #adb5bd;
        border-radius: 50%;
        animation: typing 1.4s infinite ease-in-out both;
        margin: 0 2px;
    }

    .typing-dot:nth-child(1) {
        animation-delay: -0.32s;
    }

    .typing-dot:nth-child(2) {
        animation-delay: -0.16s;
    }

    @keyframes typing {

        0%,
        80%,
        100% {
            transform: scale(0);
        }

        40% {
            transform: scale(1);
        }
    }

    .mic-active {
        background-color: #dc3545 !important;
        animation: pulse-red 1.5s infinite;
    }

    @keyframes pulse-red {
        0% {
            box-shadow: 0 0 0 0 rgba(220, 53, 69, 0.7);
        }

        70% {
            box-shadow: 0 0 0 10px rgba(220, 53, 69, 0);
        }

        100% {
            box-shadow: 0 0 0 0 rgba(220, 53, 69, 0);
        }
    }

    .speak-btn {
        background: none;
        border: none;
        color: #6c757d;
        cursor: pointer;
        padding: 0;
        margin-left: 8px;
        font-size: 0.8rem;
        transition: color 0.2s;
    }

    .speak-btn:hover {
        color: #0d6efd;
    }
</style>

<script>
    document.addEventListener('DOMContentLoaded', function () {
        const toggleBtn = document.getElementById('chatbot-toggle-btn');
        const closeBtn = document.getElementById('chatbot-close-btn');
        const windowEl = document.getElementById('chatbot-window');
        const form = document.getElementById('chatbot-form');
        const input = document.getElementById('chatbot-input');
        const messagesDiv = document.getElementById('chatbot-messages');
        const micBtn = document.getElementById('mic-btn');

        // --- Voice Features (STT) ---
        if ('webkitSpeechRecognition' in window) {
            const recognition = new webkitSpeechRecognition();
            recognition.continuous = false;
            recognition.lang = 'en-US';

            micBtn.addEventListener('click', () => {
                if (micBtn.classList.contains('mic-active')) {
                    recognition.stop();
                } else {
                    recognition.start();
                }
            });

            recognition.onstart = () => {
                micBtn.classList.add('mic-active');
                micBtn.innerHTML = '<i class="fas fa-microphone-slash px-1"></i>';
            };

            recognition.onend = () => {
                micBtn.classList.remove('mic-active');
                micBtn.innerHTML = '<i class="fas fa-microphone fa-sm"></i>';
            };

            recognition.onresult = (event) => {
                const transcript = event.results[0][0].transcript;
                input.value = transcript;
                input.focus();
            };
        } else {
            micBtn.style.display = 'none'; // Hide if not supported
        }

        // --- Voice Features (TTS) ---
        window.speakText = function (text) {
            if ('speechSynthesis' in window) {
                window.speechSynthesis.cancel(); // Stop talking if already talking
                const utterance = new SpeechSynthesisUtterance(text);
                // Clean markdown from speech
                const cleanText = text.replace(/\*\*/g, '').replace(/<[^>]*>/g, '');
                utterance.text = cleanText;

                // Voice Tuning (Female / Soft)
                const voices = window.speechSynthesis.getVoices();
                // Prioritize known "soft/female" voices
                const preferredVoice = voices.find(v =>
                    v.name.includes('Zira') ||           // Windows (Microsoft Zira)
                    v.name.includes('Google US English') || // Chrome (Google US English is female)
                    v.name.includes('Samantha') ||       // macOS
                    v.name.includes('Female')
                );

                if (preferredVoice) {
                    utterance.voice = preferredVoice;
                }

                // Soften the tone
                utterance.pitch = 1.0;
                utterance.rate = 1.0;
                utterance.volume = 1.0;

                window.speechSynthesis.speak(utterance);
            }
        }

        // Toggle Visibility
        window.toggleChat = function () {
            if (windowEl.style.display === 'none') {
                windowEl.style.display = 'flex';
                toggleBtn.style.display = 'none';
                input.focus();
            } else {
                windowEl.style.display = 'none';
                toggleBtn.style.display = 'flex';

                // Stop features on close
                if ('speechSynthesis' in window) window.speechSynthesis.cancel();
                if ('webkitSpeechRecognition' in window && micBtn.classList.contains('mic-active')) {
                    micBtn.click(); // toggle off
                }
            }
        }

        toggleBtn.addEventListener('click', window.toggleChat);
        closeBtn.addEventListener('click', window.toggleChat);

        // Send Message
        form.addEventListener('submit', async (e) => {
            e.preventDefault();
            const message = input.value.trim();
            if (!message) return;

            // Add User Message
            appendMessage(message, 'user');
            input.value = '';

            // Show Typing Indicator
            const loaderId = appendTyping();
            scrollToBottom();

            try {
                const res = await fetch('/chatbot/ask', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ message })
                });

                // Check for JSON response
                const contentType = res.headers.get("content-type");
                if (contentType && contentType.indexOf("application/json") !== -1) {
                    const data = await res.json();

                    if (document.getElementById(loaderId)) document.getElementById(loaderId).remove();

                    if (data.success) {
                        appendMessage(data.reply, 'ai');
                    } else {
                        appendMessage(`Error: ${data.error || "Sorry, I couldn't process that."}`, 'ai');
                    }
                } else {
                    // Non-JSON response (likely HTML error or Redirect)
                    if (document.getElementById(loaderId)) document.getElementById(loaderId).remove();

                    if (res.status === 401 || res.status === 403 || res.redirected) {
                        appendMessage("Session expired. Please refresh the page.", 'ai');
                    } else {
                        const text = await res.text();
                        console.error("Non-JSON API Response:", text);
                        appendMessage("Server error. Please try again later.", 'ai');
                    }
                }

            } catch (err) {
                console.error(err);
                if (document.getElementById(loaderId)) document.getElementById(loaderId).remove();
                appendMessage("Connection error. Please check your internet.", 'ai');
            }
            scrollToBottom();
        });

        function appendMessage(text, sender) {
            const div = document.createElement('div');
            // Align items to end so speaker icon sits at bottom right
            div.className = 'd-flex mb-3 w-100 align-items-end';

            const bubble = document.createElement('div');
            bubble.className = sender === 'user' ? 'chat-bubble-user' : 'chat-bubble-ai';

            // Simple markdown-ish bold parser
            bubble.innerHTML = text.replace(/\*\*(.*?)\*\*/g, '<b>$1</b>').replace(/\n/g, '<br>');

            div.appendChild(bubble);

            // Add Speak Button for AI
            if (sender === 'ai') {
                const speakBtn = document.createElement('button');
                speakBtn.className = 'speak-btn';
                speakBtn.innerHTML = '<i class="fas fa-volume-up"></i>';
                speakBtn.onclick = () => window.speakText(text);
                speakBtn.title = "Read aloud";
                div.appendChild(speakBtn);
            }

            messagesDiv.appendChild(div);
        }

        function appendTyping() {
            const id = 'typing-' + Date.now();
            const div = document.createElement('div');
            div.id = id;
            div.className = 'd-flex mb-3 theme-typing';
            div.innerHTML = `
                <div class="chat-bubble-ai d-flex align-items-center" style="padding: 12px;">
                    <div class="typing-dot"></div>
                    <div class="typing-dot"></div>
                    <div class="typing-dot"></div>
                </div>
            `;
            messagesDiv.appendChild(div);
            return id;
        }

        function scrollToBottom() {
            messagesDiv.scrollTop = messagesDiv.scrollHeight;
        }
    });
</script>