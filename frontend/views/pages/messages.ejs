<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Messages</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <link rel="stylesheet" href="/css/style.css">
    <style>
        .chat-container {
            height: calc(100vh - 160px);
            background: #fff;
            border-radius: 12px;
            overflow: hidden;
            border: 1px solid #eef2f6;
        }

        .chat-sidebar {
            width: 350px;
            background: #f8f9fa;
            border-right: 1px solid #eef2f6;
            display: flex;
            flex-direction: column;
        }

        .chat-main {
            flex: 1;
            display: flex;
            flex-direction: column;
            background: #fff;
        }

        .contact-list {
            flex: 1;
            overflow-y: auto;
        }

        .contact-item {
            padding: 15px 20px;
            cursor: pointer;
            transition: all 0.2s;
            border-bottom: 1px solid #f0f0f0;
        }

        .contact-item:hover,
        .contact-item.active {
            background: #fff;
            border-left: 4px solid var(--primary-color);
        }

        .contact-avatar {
            width: 45px;
            height: 45px;
            border-radius: 50%;
            object-fit: cover;
            background: #e9ecef;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            color: #6c757d;
            flex-shrink: 0;
        }

        .message-area {
            flex: 1;
            overflow-y: auto;
            padding: 20px;
            background: #fdfdfd;
        }

        .message-input-area {
            padding: 20px;
            background: #fff;
            border-top: 1px solid #eef2f6;
        }

        .message-bubble {
            max-width: 70%;
            padding: 10px 15px;
            border-radius: 15px;
            margin-bottom: 15px;
            position: relative;
            font-size: 0.95rem;
            word-wrap: break-word;
        }

        .message-sent {
            background: #0d6efd;
            /* Bootstrap Primary Blue */
            color: #fff;
            align-self: flex-end;
            margin-left: auto;
            /* Force push to right */
            border-bottom-right-radius: 5px;
            text-align: right;
        }

        .message-received {
            background: #f1f3f5;
            color: #333;
            align-self: flex-start;
            margin-right: auto;
            /* Force push to left */
            border-bottom-left-radius: 5px;
            text-align: left;
        }

        .empty-state {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            height: 100%;
            color: #adb5bd;
        }

        /* Fix for sidebar toggle z-index if needed */
        #wrapper.toggled #sidebar-wrapper {
            margin-left: 0;
        }
    </style>
</head>

<body>
    <div class="d-flex" id="wrapper">
        <%- include('../partials/sidebar') %>
            <div id="page-content-wrapper" class="main-gradient-bg">
                <nav class="navbar navbar-expand-lg navbar-light bg-transparent py-4 px-4">
                    <div class="d-flex align-items-center">
                        <i class="fas fa-align-left primary-text fs-4 me-3" id="menu-toggle"
                            style="cursor: pointer;"></i>
                        <h2 class="fs-2 m-0 text-dark fw-bold">Messages</h2>
                    </div>
                </nav>

                <div class="container-fluid px-4 pb-4">
                    <div class="chat-container d-flex shadow-sm">
                        <!-- Sidebar -->
                        <div class="chat-sidebar" id="chatSidebar">
                            <div class="p-3 border-bottom position-relative">
                                <div class="input-group">
                                    <span class="input-group-text bg-white border-end-0"><i
                                            class="fas fa-search text-muted"></i></span>
                                    <input type="text" id="userSearch"
                                        class="form-control border-start-0 ps-0 text-muted"
                                        placeholder="Search Name or ID...">
                                </div>
                                <div id="searchResults" class="list-group position-absolute mt-1 shadow-sm w-100"
                                    style="z-index: 1000; left: 0; display: none; max-height: 300px; overflow-y: auto;">
                                </div>
                            </div>

                            <div class="contact-list" id="contactList">
                                <% if(contacts && contacts.length> 0) { %>
                                    <% contacts.forEach(c=> { %>
                                        <div class="contact-item d-flex align-items-center" data-id="<%= c._id %>"
                                            data-name="<%= c.fullName %>" data-pic="<%= getProfilePic(c) %>"
                                            onclick="selectContact('<%= c._id %>', '<%= c.fullName %>', '<%= getProfilePic(c) %>')">

                                            <img src="<%= getProfilePic(c) %>" class="contact-avatar me-3"
                                                onerror="this.onerror=null; this.src='/images/patient-default.png';">
                                            <div class="contact-avatar me-3" style="display:none; background: #e2e6ea;">
                                                <%= c.fullName.charAt(0) %>
                                            </div>

                                            <div style="flex: 1; min-width: 0;">
                                                <div class="d-flex justify-content-between">
                                                    <h6 class="mb-0 fw-bold text-truncate">
                                                        <%= c.fullName %>
                                                    </h6>
                                                    <% if(c.unread && c.unread> 0) { %>
                                                        <span class="badge bg-danger rounded-pill unread-badge">
                                                            <%= c.unread %>
                                                        </span>
                                                        <% } %>
                                                </div>
                                                <small class="text-muted d-block text-truncate">
                                                    <%= c.role.toUpperCase() %>
                                                        <%= c.speciality ? 'â€¢ ' + c.speciality : '' %>
                                                </small>
                                                <small class="text-muted" style="font-size: 0.75rem;">ID: <%= c._id %>
                                                </small>
                                            </div>
                                        </div>
                                        <% }) %>
                                            <% } else { %>
                                                <div class="text-center p-4 text-muted small">
                                                    No contacts found. Use search to find someone.
                                                </div>
                                                <% } %>
                            </div>
                        </div>

                        <!-- Main Chat -->
                        <div class="chat-main">
                            <!-- Header -->
                            <div class="d-flex align-items-center p-3 border-bottom bg-white" id="chatHeader"
                                style="visibility: hidden;">
                                <img src="" id="headerAvatar" class="contact-avatar me-3"
                                    style="width: 40px; height: 40px;">
                                <div>
                                    <h6 class="mb-0 fw-bold" id="headerName">User</h6>
                                    <small class="text-muted" id="headerStatus">Online</small>
                                </div>
                            </div>

                            <!-- Messages -->
                            <div class="message-area d-flex flex-column" id="messageArea">
                                <div class="empty-state">
                                    <i class="fas fa-comments fa-3x mb-3 opacity-50"></i>
                                    <h5>Select a conversation</h5>
                                    <p>Choose a contact from the left to start chatting</p>
                                </div>
                            </div>

                            <!-- Input -->
                            <div class="message-input-area" id="inputArea" style="visibility: hidden;">
                                <form id="messageForm" class="d-flex gap-2">
                                    <% if(typeof reports !=='undefined' && reports.length> 0) { %>
                                        <button type="button" class="btn btn-light rounded-circle shadow-sm"
                                            data-bs-toggle="modal" data-bs-target="#attachmentModal"
                                            title="Attach Report">
                                            <i class="fas fa-paperclip text-muted"></i>
                                        </button>
                                        <% } %>
                                            <input type="text" id="messageInput"
                                                class="form-control rounded-pill bg-light border-0 px-4"
                                                placeholder="Type a message..." autocomplete="off">
                                            <button type="submit"
                                                class="btn btn-primary rounded-circle shadow-sm d-flex align-items-center justify-content-center"
                                                style="width: 45px; height: 45px; transition: transform 0.2s;">
                                                <i class="fas fa-arrow-up"></i>
                                            </button>
                                </form>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
    </div>

    <!-- Attachment Modal -->
    <% if(typeof reports !=='undefined' && reports.length> 0) { %>
        <div class="modal fade" id="attachmentModal" tabindex="-1">
            <div class="modal-dialog modal-dialog-centered">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title">Attach Report</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                    </div>
                    <div class="modal-body">
                        <div class="list-group">
                            <% reports.forEach(function(rep) { %>
                                <button type="button"
                                    class="list-group-item list-group-item-action d-flex justify-content-between align-items-center"
                                    onclick="selectAttachment('<%= rep._id %>', '<%= rep.title %>')">
                                    <div>
                                        <i
                                            class="fas <%= rep.mimeType && rep.mimeType.startsWith('image') ? 'fa-image' : 'fa-file-pdf' %> me-2 text-primary"></i>
                                        <%= rep.title %>
                                    </div>
                                    <small class="text-muted">
                                        <%= new Date(rep.uploadedAt).toLocaleDateString() %>
                                    </small>
                                </button>
                                <% }) %>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <% } %>

            <%- include('../partials/footer') %>
                <script src="/socket.io/socket.io.js"></script>
                <script>
                    let selectedAttachment = null;

                    function selectAttachment(id, title) {
                        selectedAttachment = { id, title };
                        const input = document.getElementById('messageInput');
                        input.value = `[Attachment: ${title}] ` + input.value;
                        input.focus();

                        // Close modal
                        const modal = bootstrap.Modal.getInstance(document.getElementById('attachmentModal'));
                        modal.hide();
                    }

                    document.addEventListener("DOMContentLoaded", function () {
                        // Initialize Socket
                        const socket = io();
                        const currentUserId = "<%= user._id %>";
                        const currentUserName = "<%= user.fullName %>";
                        let activeChatId = null;

                        // Auto-select contact from URL
                        const urlParams = new URLSearchParams(window.location.search);
                        const targetUserId = urlParams.get('userId');
                        if (targetUserId) {
                            // Wait for contact list to render before trying to click
                            setTimeout(() => {
                                const contactEl = document.querySelector(`.contact-item[data-id="${targetUserId}"]`);
                                if (contactEl) {
                                    contactEl.click();
                                    // Scroll contact into view
                                    contactEl.scrollIntoView({ behavior: 'smooth', block: 'center' });
                                }
                            }, 100); // Small delay to ensure DOM is ready and contacts are rendered
                        }

                        socket.on('connect', () => {
                            console.log("Connected to socket server");
                            socket.emit('join', currentUserId);
                        });

                        // 1. Fix Sidebar Toggle
                        const el = document.getElementById("wrapper");
                        const toggleButton = document.getElementById("menu-toggle");

                        if (toggleButton && el) {
                            toggleButton.addEventListener('click', function (e) {
                                e.preventDefault();
                                el.classList.toggle("toggled");
                            });
                        } else {
                            console.error("Sidebar elements not found!");
                        }

                        // 2. Fix Search
                        const searchInput = document.getElementById('userSearch');
                        const resultsBox = document.getElementById('searchResults');

                        if (searchInput) {
                            searchInput.addEventListener('input', async (e) => {
                                const query = e.target.value.trim();
                                if (query.length < 1) {
                                    resultsBox.style.display = 'none';
                                    return;
                                }

                                try {
                                    const res = await fetch(`/messages/search?q=${encodeURIComponent(query)}`);
                                    if (!res.ok) throw new Error("Search failed");
                                    const users = await res.json();

                                    resultsBox.innerHTML = '';
                                    if (users.length > 0) {
                                        resultsBox.style.display = 'block';
                                        users.forEach(u => {
                                            const item = document.createElement('a');
                                            item.className = 'list-group-item list-group-item-action';
                                            item.style.cursor = 'pointer';
                                            item.innerHTML = `
                                    <div class="d-flex justify-content-between align-items-center">
                                        <div>
                                            <strong>${u.fullName}</strong> 
                                            <small class="text-muted ms-1">(${u.role})</small>
                                            <div class="small text-muted" style="font-size: 0.75em;">ID: ${u._id}</div>
                                        </div>
                                    </div>`;
                                            // Bind click directly
                                            item.addEventListener('click', () => {
                                                selectContact(u._id, u.fullName, u.profilePic);
                                                resultsBox.style.display = 'none';
                                                searchInput.value = '';
                                            });
                                            resultsBox.appendChild(item);
                                        });
                                    } else {
                                        resultsBox.innerHTML = '<div class="list-group-item text-muted">No results</div>';
                                        resultsBox.style.display = 'block';
                                    }
                                } catch (err) {
                                    console.error(err);
                                }
                            });

                            // Close search when clicking outside
                            document.addEventListener('click', function (e) {
                                if (!searchInput.contains(e.target) && !resultsBox.contains(e.target)) {
                                    resultsBox.style.display = 'none';
                                }
                            });
                        }

                        // Global generic function for selection
                        window.selectContact = async (id, name, pic) => {
                            activeChatId = id;
                            console.log("Active Chat Set To:", activeChatId);

                            // Update active state in list
                            document.querySelectorAll('.contact-item').forEach(i => i.classList.remove('active'));
                            const existing = document.querySelector(`.contact-item[data-id="${id}"]`);
                            if (existing) {
                                existing.classList.add('active');
                                // Hide badge locally
                                const badge = existing.querySelector('.unread-badge');
                                if (badge) badge.style.display = 'none';
                            }

                            // Show UI
                            document.getElementById('chatHeader').style.visibility = 'visible';
                            document.getElementById('inputArea').style.visibility = 'visible';
                            document.getElementById('headerName').innerText = name;

                            const img = document.getElementById('headerAvatar');
                            if (pic && pic !== 'undefined') {
                                img.src = pic;
                                img.style.display = 'block';
                            } else {
                                img.src = '/images/patient-default.png';
                            }

                            // Load Messages
                            const msgArea = document.getElementById('messageArea');
                            msgArea.innerHTML = '<div class="text-center p-4"><i class="fas fa-spinner fa-spin text-muted"></i></div>';

                            try {
                                const res = await fetch(`/messages/${id}`);
                                const messages = await res.json();

                                msgArea.innerHTML = '';
                                if (messages.length === 0) {
                                    msgArea.innerHTML = '<div class="text-center text-muted mt-5 small">No messages yet. Say hi!</div>';
                                } else {
                                    messages.forEach(m => appendMessage(m));
                                }
                                scrollToBottom();
                            } catch (err) {
                                msgArea.innerHTML = '<div class="text-danger text-center">Failed to load messages</div>';
                            }
                        };

                        // Send
                        const msgForm = document.getElementById('messageForm');
                        if (msgForm) {
                            msgForm.onsubmit = async (e) => {
                                e.preventDefault();
                                const input = document.getElementById('messageInput');
                                // Clean content of the [Attachment] marker if present, or keep it as text description
                                // Ideally we send attachmentId properly.

                                let content = input.value.trim();
                                if (!content && !selectedAttachment) return;

                                // If attachment is selected but user cleared text, default to "Sent an attachment"
                                if (!content && selectedAttachment) content = "Sent an attachment";

                                if (!activeChatId) return;

                                const payload = {
                                    receiverId: activeChatId,
                                    content: content
                                };

                                if (selectedAttachment) {
                                    payload.attachmentId = selectedAttachment.id;
                                }

                                // Reset selected attachment UI logic locally (simplified)
                                const tempAttachment = selectedAttachment;
                                selectedAttachment = null;

                                // Optimistic append? Wait for server for attachment details?
                                // Let's optimistic append text, but for attachment we might need details.
                                // Actually, since we have the details in tempAttachment, we can optimistic render!

                                const optimisticMsg = {
                                    senderId: currentUserId,
                                    content: content,
                                    timestamp: new Date(),
                                    attachment: tempAttachment ? { _id: tempAttachment.id, title: tempAttachment.title, mimeType: 'application/pdf', fileUrl: '#' } : null // Mock for immediate display (link won't work until refresh technically unless we use actual URL if available in list)
                                };

                                // Note: To make the link work optimistically we'd need the URL in the select list. 
                                // For now let's just append.

                                // Socket emit
                                socket.emit('private_message', {
                                    senderId: currentUserId,
                                    receiverId: activeChatId,
                                    content: content,
                                    senderName: currentUserName,
                                    attachment: tempAttachment // simplified
                                });

                                const res = await fetch('/messages/send', {
                                    method: 'POST',
                                    headers: { 'Content-Type': 'application/json' },
                                    body: JSON.stringify(payload)
                                });

                                const savedMsg = await res.json();

                                // Append the REAL saved message which has the populated attachment info (URL etc)
                                if (savedMsg.success) {
                                    appendMessage(savedMsg.message);
                                }

                                input.value = '';
                                scrollToBottom();
                            };
                        }

                        socket.on('receive_message', (data) => {
                            console.log("Received data:", data);
                            // Robust check
                            if (String(activeChatId) === String(data.senderId)) {
                                appendMessage(data);
                                scrollToBottom();
                            } else {
                                // Increment unread badge
                                const contactItem = document.querySelector(`.contact-item[data-id="${data.senderId}"]`);
                                if (contactItem) {
                                    let badge = contactItem.querySelector('.unread-badge');
                                    if (!badge) {
                                        const badgeContainer = contactItem.querySelector('.d-flex.justify-content-between');
                                        if (badgeContainer) {
                                            badge = document.createElement('span');
                                            badge.className = 'badge bg-danger rounded-pill unread-badge';
                                            badge.innerText = '0';
                                            badgeContainer.appendChild(badge);
                                        }
                                    }
                                    if (badge) {
                                        let count = parseInt(badge.innerText) || 0;
                                        badge.innerText = count + 1;
                                        badge.style.display = 'inline-block';
                                    }
                                }
                            }
                        });

                        function appendMessage(msg) {
                            const isMe = String(msg.senderId) === String(currentUserId);
                            const div = document.createElement('div');
                            div.className = `message-bubble ${isMe ? 'message-sent' : 'message-received'}`;

                            const time = new Date(msg.timestamp).toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });

                            let attachmentHtml = '';
                            if (msg.attachment) {
                                // Compatibility with both populated object and socket data
                                const attTitle = msg.attachment.title || 'Attachment';
                                const attUrl = msg.attachment.fileUrl || '#';
                                attachmentHtml = `
                            <div class="mb-2 p-2 bg-light rounded text-dark d-flex align-items-center">
                                <i class="fas fa-paperclip me-2 text-primary"></i>
                                <div class="text-truncate" style="max-width: 150px;">
                                    <a href="${attUrl}" target="_blank" class="fw-bold text-dark text-decoration-none">${attTitle}</a>
                                </div>
                            </div>
                         `;
                            }

                            div.innerHTML = `${attachmentHtml}${msg.content} <div class="text-end" style="font-size: 0.7rem; opacity: 0.7; margin-top: 4px;">${time}</div>`;
                            document.getElementById('messageArea').appendChild(div);
                        }

                        function scrollToBottom() {
                            const area = document.getElementById('messageArea');
                            area.scrollTop = area.scrollHeight;
                        }
                    });
                </script>
</body>

</html>